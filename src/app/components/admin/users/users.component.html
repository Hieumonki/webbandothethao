<div class="page-header">
  <div>
    <h1>Quản lý khách hàng</h1>
    <small>Theo dõi các số liệu chính. Kiểm tra báo cáo và xem thông tin chi tiết.</small>
  </div>
  <div class="header-actions">
    <button (click)="exportUsers()">
      <span class="las la-file-export"></span>
      Export
    </button>
    <button (click)="openSettings()">
      <span class="las la-tools"></span>
      Settings
    </button>
  </div>
</div>

<div class="user-cards">
  <div class="card-single card-color-1">
    <div class="card-flex">
      <div class="card-info">
        <div class="card-head">
          <span>Tổng người dùng</span>
          <small>Số lượng người dùng đã đăng ký</small>
        </div>
        <h2>{{ isLoadingStats ? 'Đang tải...' : userStats.totalUsers }}</h2>
        <small>Tất cả tài khoản</small>
      </div>
      <div class="card-chart success">
        <i class="fa-solid fa-users"></i>
      </div>
    </div>
  </div>
  <div class="card-single card-color-2">
    <div class="card-flex">
      <div class="card-info">
        <div class="card-head">
          <span>Đang hoạt động</span>
          <small>Người dùng đang online</small>
        </div>
        <h2>{{ isLoadingStats ? 'Đang tải...' : userStats.activeUsers }}</h2>
        <small>Tài khoản kích hoạt</small>
      </div>
      <div class="card-chart danger">
        <i class="fa-solid fa-users-gear"></i>
      </div>
    </div>
  </div>
  <div class="card-single card-color-2">
    <div class="card-flex">
      <div class="card-info">
        <div class="card-head">
          <span>Bị khóa</span>
          <small>Tài khoản bị tạm khóa</small>
        </div>
        <h2>{{ isLoadingStats ? 'Đang tải...' : userStats.lockedUsers }}</h2>
        <small>Tài khoản bị khóa</small>
      </div>
      <div class="card-chart danger">
        <i class="fa-solid fa-users-slash"></i>
      </div>
    </div>
  </div>
  <div class="card-single card-color-3">
    <div class="card-flex">
      <div class="card-info">
        <div class="card-head">
          <span>Chờ duyệt</span>
          <small>Tài khoản chờ xác thực</small>
        </div>
        <h2>{{ isLoadingStats ? 'Đang tải...' : userStats.pendingUsers }}</h2>
        <small>Tài khoản chờ duyệt</small>
      </div>
      <div class="card-chart yellow">
        <i class="fa-solid fa-clipboard-user"></i>
      </div>
    </div>
  </div>
</div>

<div class="details">
  <div class="recentOrders">
    <div class="cardHeader">
      <h2>Danh Sách Khách Hàng</h2>
      <a href="#" class="btn" (click)="openUsersModal($event)">View All</a>
    </div>
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <td>Tên Khách Hàng</td>
            <td>Email</td>
            <td>Số Điện Thoại</td>
            <td>Địa Chỉ</td>
            <td>Trạng Thái</td>
          </tr>
        </thead>
        <tbody>
          <tr *ngIf="isLoadingUsers">
            <td colspan="5">Đang tải...</td>
          </tr>
          <tr *ngIf="!isLoadingUsers && errorUsers">
            <td colspan="5">{{ errorUsers }}</td>
          </tr>
          <tr *ngIf="!isLoadingUsers && !errorUsers && filteredUsers.length === 0">
            <td colspan="5">Không có khách hàng nào để hiển thị.</td>
          </tr>
          <tr *ngFor="let user of filteredUsers; trackBy: trackByUserId">
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.phone ?? 'N/A' }}</td>
            <td>{{ user.address ?? 'N/A' }}</td>
            <td><span class="status {{ user.status }}">{{ translateUserStatus(user.status) }}</span></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="rencentCustomers">
    <div class="cardHeader">
      <h2>Recent Customers</h2>
    </div>
    <div class="customers-container">
      <table id="customersTable">
        <tbody>
          <tr *ngIf="isLoadingUsers">
            <td colspan="3">Đang tải...</td>
          </tr>
          <tr *ngIf="!isLoadingUsers && errorUsers">
            <td colspan="3">{{ errorUsers }}</td>
          </tr>
          <tr *ngIf="!isLoadingUsers && !errorUsers && filteredUsers.length === 0">
            <td colspan="3">Không có người dùng nào để hiển thị.</td>
          </tr>
          <tr *ngFor="let user of filteredUsers">
            <td width="60px">
              <div class="imgBx">
                <img [src]="user.avatar || 'https://via.placeholder.com/40x40/CCCCCC/FFFFFF?text=' + (user.name | slice:0:1)" [alt]="user.name">
              </div>
            </td>
            <td>
              <h4>{{ user.name }}<br><span>Viet Nam</span></h4>
            </td>
            <td class="action-cell">
              <button class="lock-btn" [ngClass]="user.status === 'locked' ? 'locked' : 'unlocked'" (click)="toggleLockUser(user)" [title]="user.status === 'locked' ? 'Unlock User' : 'Lock User'">
                <i class="fas" [ngClass]="user.status === 'locked' ? 'fa-lock' : 'fa-unlock'"></i>
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<div id="usersModal" class="modal-overlay" [ngClass]="{ 'active': isUsersModalOpen }">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Quản Lý Khách Hàng</h3>
      <button class="close-btn" (click)="closeUsersModal()">×</button>
    </div>
    <div class="action-buttons">
      <button class="action-btn delete-btn" (click)="deleteSelectedUsers()" [disabled]="!hasSelectedUsers">
        <span><i class="fa-solid fa-trash-can"></i></span> Delete Selected
      </button>
      <button class="action-btn status-filter" (click)="filterUsersByStatus('active')">
        <span><i class="fa-thin fa-chart-simple"></i></span> Active
      </button>
      <button class="action-btn status-filter" (click)="filterUsersByStatus('locked')">
        <span><i class="fa-thin fa-chart-simple"></i></span> Locked
      </button>
      <button class="action-btn status-filter" (click)="filterUsersByStatus('pending')">
        <span><i class="fa-thin fa-chart-simple"></i></span> Pending
      </button>
    </div>
    <table class="modal-table">
      <thead>
        <tr>
          <th class="checkbox-cell">
            <input type="checkbox" id="selectAll" [(ngModel)]="selectAll" (change)="toggleSelectAll()">
          </th>
          <th>Tên Khách Hàng</th>
          <th>Email</th>
          <th>Số Điện Thoại</th>
          <th>Địa Chỉ</th>
          <th>Vi Phạm</th>
          <th>Trạng Thái</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngIf="isLoadingUsers">
          <td colspan="8">Đang tải...</td>
        </tr>
        <tr *ngIf="!isLoadingUsers && errorUsers">
          <td colspan="8">{{ errorUsers }}</td>
        </tr>
        <tr *ngIf="!isLoadingUsers && !errorUsers && filteredUsers.length === 0">
          <td colspan="8">Không có khách hàng nào để hiển thị.</td>
        </tr>
        <tr *ngFor="let user of filteredUsers; trackBy: trackByUserId">
          <td class="checkbox-cell">
            <input type="checkbox" [(ngModel)]="user.selected" (change)="updateSelectedUsers()">
          </td>
          <td>{{ user.name }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.phone ?? 'N/A' }}</td>
          <td>{{ user.address ?? 'N/A' }}</td>
          <td>{{ getViolationDetails(user) }}</td>
          <td><span class="status {{ user.status }}">{{ translateUserStatus(user.status) }}</span></td>
          <td class="actions">
            <button class="lock-btn" [ngClass]="user.status === 'locked' ? 'locked' : 'unlocked'" (click)="toggleLockUser(user)" [title]="user.status === 'locked' ? 'Unlock User' : 'Lock User'">
              <i class="fas" [ngClass]="user.status === 'locked' ? 'fa-lock' : 'fa-unlock'"></i>
            </button>
            <button class="action-icon view-icon" (click)="viewUserDetails(user)" title="View">
              <i class="fa-solid fa-eye"></i>
            </button>
            <button class="action-icon delete-icon" (click)="deleteUser(user)" title="Delete">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
